name: cd-merge-dev

on:
    pull_request:
        branches: [dev]

concurrency:
    group: cd-merge-dev-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    id-token: write
    deployments: write

env:
    NODE_VERSION: '20'
    PNPM_VERSION: '9'
    GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID_STAGING }}
    GCP_REGION: ${{ vars.GCP_REGION }}
    STAGING_WEB_HOSTNAME: ${{ vars.STAGING_WEB_HOSTNAME }}
    STAGING_MOBILE_HOSTNAME: ${{ vars.STAGING_MOBILE_HOSTNAME }}
    STAGING_API_URL: ${{ vars.STAGING_API_URL }}

jobs:
    changes:
        name: Detect changed paths
        runs-on: ubuntu-latest
        outputs:
            web_changed: ${{ steps.filter.outputs.web }}
            api_changed: ${{ steps.filter.outputs.api }}
            mobile_changed: ${{ steps.filter.outputs.mobile }}
            any_changed: ${{ steps.filter.outputs.any_changed }}
        steps:
            - uses: actions/checkout@v4
            - id: filter
              uses: tj-actions/changed-files@v45
              with:
                  separator: ','
                  files_yaml: |
                      web:
                        - 'apps/web/**'
                      api:
                        - 'apps/api/**'
                      mobile:
                        - 'apps/mobile/**'
                      any_changed:
                        - 'apps/**'
                        - 'packages/**'
                        - 'pnpm-lock.yaml'
                        - 'turbo.json'
                        - 'package.json'

    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: changes
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'
            - name: Install
              run: pnpm install --frozen-lockfile
            - name: Lint
              run: pnpm lint

    test_api_e2e:
        name: API E2E (emulator)
        runs-on: ubuntu-latest
        needs: lint
        if: needs.changes.outputs.api_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'
            - name: Install
              run: pnpm install --frozen-lockfile
            - name: Start API (emulator) & run E2E
              run: |
                  pnpm --filter @crm/api build
                  pnpm --filter @crm/api start:emulator &
                  npx -y wait-on tcp:3001
                  pnpm --filter @crm/api test:e2e
            - name: Upload API E2E report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: api-e2e-report
                  path: apps/api/test-results/**
                  if-no-files-found: ignore

    test_web_e2e:
        name: Web E2E (local)
        runs-on: ubuntu-latest
        needs: lint
        if: needs.changes.outputs.web_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'
            - name: Install
              run: pnpm install --frozen-lockfile
            - name: Build web
              run: pnpm --filter @crm/web build
            - name: Start web locally
              run: pnpm --filter @crm/web start &
            - name: Wait for web
              run: npx -y wait-on http://localhost:3000/health
            - name: Run Playwright (local)
              run: |
                  npx -y @playwright/test@1.56.0 install --with-deps
                  BASE_URL=http://localhost:3000 npx -y @playwright/test@1.56.0 test apps/web/test
            - name: Upload Web E2E report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: web-e2e-report-local
                  path: apps/web/test-results/**
                  if-no-files-found: ignore

    test_mobile_e2e:
        name: Mobile E2E (Expo Web)
        runs-on: ubuntu-latest
        needs: lint
        if: needs.changes.outputs.mobile_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'
            - name: Install
              run: pnpm install --frozen-lockfile
            - name: Build Expo Web
              run: pnpm --filter @crm/mobile build:web
            - name: Start Expo Web preview
              run: pnpm --filter @crm/mobile preview:web &
            - name: Wait for mobile web
              run: npx -y wait-on http://localhost:5173
            - name: Run Playwright (Expo Web)
              run: |
                  npx -y @playwright/test@1.56.0 install --with-deps
                  BASE_URL=http://localhost:5173 npx -y @playwright/test@1.56.0 test apps/mobile/test
            - name: Upload Mobile E2E report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: mobile-e2e-report
                  path: apps/mobile/test-results/**
                  if-no-files-found: ignore

    build:
        name: Build Artifacts
        runs-on: ubuntu-latest
        needs: [lint, test_api_e2e, test_web_e2e, test_mobile_e2e]
        if: |
            always() &&
            (needs.lint.result == 'success') &&
            (needs.test_api_e2e.result == 'success' || needs.changes.outputs.api_changed != 'true') &&
            (needs.test_web_e2e.result == 'success' || needs.changes.outputs.web_changed != 'true') &&
            (needs.test_mobile_e2e.result == 'success' || needs.changes.outputs.mobile_changed != 'true')
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'
            - name: Install
              run: pnpm install --frozen-lockfile
            - name: Build API
              if: needs.changes.outputs.api_changed == 'true'
              run: pnpm --filter @crm/api build
            - name: Build WEB
              if: needs.changes.outputs.web_changed == 'true'
              run: pnpm --filter @crm/web build
            - name: Build MOBILE (Expo web artifact)
              if: needs.changes.outputs.mobile_changed == 'true'
              run: pnpm --filter @crm/mobile build:web
            - name: Upload built artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      apps/api/dist/**
                      apps/web/dist/**
                      apps/mobile/dist-web/**
                  if-no-files-found: ignore

    deploy_api:
        name: Deploy API (nest)
        runs-on: ubuntu-latest
        needs: build
        if: needs.changes.outputs.api_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
            - uses: google-github-actions/setup-gcloud@v2
            - name: Build & push API image
              run: gcloud builds submit apps/api --tag "gcr.io/${GCP_PROJECT_ID}/api:${{ github.sha }}"
            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy api-staging \
                    --project ${GCP_PROJECT_ID} \
                    --region ${GCP_REGION} \
                    --image gcr.io/${GCP_PROJECT_ID}/api:${{ github.sha }} \
                    --platform managed \
                    --allow-unauthenticated \
                    --set-env-vars NODE_ENV=staging

    deploy_mobile_web:
        name: Deploy Mobile (expo:web)
        runs-on: ubuntu-latest
        needs: build
        if: needs.changes.outputs.mobile_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - run: npm i -g firebase-tools
            - name: Deploy Mobile to Hosting
              run: firebase deploy --only hosting:mobile-staging --project ${{ vars.FIREBASE_PROJECT_ID_STAGING }}

    deploy_web:
        name: Deploy Web (next)
        runs-on: ubuntu-latest
        needs: build
        if: needs.changes.outputs.web_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - run: npm i -g firebase-tools
            - name: Deploy Web to Hosting
              run: firebase deploy --only hosting:staging --project ${{ vars.FIREBASE_PROJECT_ID_STAGING }}

    api_smoke:
        name: API smoke (ping)
        runs-on: ubuntu-latest
        needs: deploy_api
        if: needs.changes.outputs.api_changed == 'true'
        steps:
            - run: curl -sfL "${{ env.STAGING_API_URL }}/health"

    mobile_smoke:
        name: Mobile smoke (Playwright â†’ deployed)
        runs-on: ubuntu-latest
        needs: deploy_mobile_web
        if: needs.changes.outputs.mobile_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
            - run: npx -y @playwright/test@1.56.0 install --with-deps
            - env:
                  BASE_URL: https://${{ env.STAGING_MOBILE_HOSTNAME }}
              run: |
                  echo "$BASE_URL"
                  npx -y @playwright/test@1.56.0 test apps/mobile/test/health
            - if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: mobile-smoke-staging
                  path: apps/mobile/test-results/**
                  if-no-files-found: ignore

    web_smoke:
        name: Web smoke (Playwright â†’ deployed)
        runs-on: ubuntu-latest
        needs: deploy_web
        if: needs.changes.outputs.web_changed == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
            - run: npx -y @playwright/test@1.56.0 install --with-deps
            - env:
                  BASE_URL: https://${{ env.STAGING_WEB_HOSTNAME }}
              run: |
                  echo "$BASE_URL"
                  npx -y @playwright/test@1.56.0 test apps/web/test/health
            - if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: web-smoke-staging
                  path: apps/web/test-results/**
                  if-no-files-found: ignore

    rollback_on_failure:
        name: Rollback (on smoke failure)
        runs-on: ubuntu-latest
        needs: [api_smoke, mobile_smoke, web_smoke]
        if: |
            needs.api_smoke.result == 'failure' ||
            needs.mobile_smoke.result == 'failure' ||
            needs.web_smoke.result == 'failure'
        steps:
            - uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
            - uses: google-github-actions/setup-gcloud@v2
            - name: Rollback API
              if: needs.changes.outputs.api_changed == 'true'
              run: |
                  SERVICE="api-staging"
                  REGION="${{ env.GCP_REGION }}"
                  PREV_REV=$(gcloud run services describe $SERVICE --region $REGION --format='value(status.traffic[1].revisionName)')
                  if [ -n "$PREV_REV" ]; then
                    gcloud run services update-traffic $SERVICE --region $REGION --to-revisions $PREV_REV=100
                  fi
            - name: Rollback Web
              if: needs.changes.outputs.web_changed == 'true'
              run: firebase hosting:channel:deploy live --project ${{ vars.FIREBASE_PROJECT_ID_STAGING }} --only hosting:staging || true
            - name: Rollback Mobile
              if: needs.changes.outputs.mobile_changed == 'true'
              run: firebase hosting:channel:deploy live --project ${{ vars.FIREBASE_PROJECT_ID_STAGING }} --only hosting:mobile-staging || true
            - run: exit 1
